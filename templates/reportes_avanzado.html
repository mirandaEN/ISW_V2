<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos específicos (ajustados) */
        main#reportesContent { /* ID para selector */
             padding: 1.5rem;
             /* Fondo ya lo da el .main-content */
             max-width: 1600px; /* Permitir más ancho para los reportes */
             margin: 0 auto; /* Centrar si hay espacio */
        }
        main#reportesContent h1 { /* Título principal */
            color: #343a40; /* Color estándar */
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-weight: 700;
            font-size: 1.8em;
        }
        /* Botones de acción (Descargar Excel) */
        .report-actions {
             margin-bottom: 1.5rem;
             text-align: right; /* Alinear a la derecha */
        }
        .report-actions .excel-btn {
             background-color: #198754; /* Verde Bootstrap */
             color: white;
             padding: 0.5rem 1rem;
             border-radius: 5px;
             text-decoration: none;
             transition: background-color 0.2s;
             border: none;
        }
        .report-actions .excel-btn:hover { background-color: #157347; }

        /* Estilos del grid y cards (se mantienen, pero dentro de main) */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.07); }
        .card h3 { margin-top: 0; font-size: 1.2em; color: #005a9c; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .card h3 i { margin-right: 8px; color: #007bff; }
        .kpi-card { text-align: center; }
        .kpi-value { font-size: 2.5em; font-weight: 700; color: #005a9c; }
        .kpi-label { font-size: 1em; color: #6c757d; margin-top: 5px; }
        .list { list-style: none; padding: 0; }
        .list li { background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .list .value { font-weight: 600; background-color: #920000; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.9em; }
        .list .date { font-size: 0.85em; color: #888; }
        .grid-col-span-2 { grid-column: span 2; }
        .table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th, .report-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .report-table th { background-color: #f8f9fa; font-weight: 600; color: #343a40; position: sticky; top: 0; }
        .report-table tr:last-child td { border-bottom: none; }
        .report-table tr:hover { background-color: #fdfdfd; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.Activo { background-color: #ffc107; }
        .status-dot.Devuelto { background-color: #28a745; }
        .list .timer { background-color: #28a745; color: white; min-width: 70px; text-align: center; }
        .flash-messages-container-local { margin-bottom: 1.5rem; }

        @media (min-width: 768px) { .grid-col-span-2 { grid-column: span 2; } }
        @media (max-width: 1200px) { .grid-col-span-2 { grid-column: span 1; } }
    </style>
</head>
<body> <main id="reportesContent">

        <h1><i class="fas fa-chart-bar me-2"></i>Reportes y Estadísticas</h1>

        <div class="flash-messages-container-local">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="report-actions">
            <a href="{{ url_for('descargar_reporte_excel') }}" class="excel-btn">
                <i class="fas fa-file-excel me-2"></i>Descargar Reporte en Excel
            </a>
        </div>


        <div class="dashboard-grid">

            <div class="card kpi-card">
                <h3><i class="fas fa-plug"></i> Préstamos Activos</h3>
                <div class="kpi-value">{{ datos.activos_ahora }}</div>
                <div class="kpi-label">Materiales en uso ahora</div>
            </div>
            <div class="card kpi-card">
                <h3><i class="fas fa-calendar-day"></i> Préstamos Hoy</h3>
                <div class="kpi-value">{{ datos.total_prestamos_hoy }}</div>
                <div class="kpi-label">Vales generados hoy</div>
            </div>

            <div class="card grid-col-span-2">
                <h3><i class="fas fa-user-clock"></i> Auxiliares Activos</h3>
                <ul id="lista-auxiliares-activos" class="list">
                    {% if datos.auxiliares_activos %}
                        {% for aux in datos.auxiliares_activos %}
                        <li>
                            <span>{{ aux.USUARIO }}</span>
                            <span class="value timer" data-login-time="{{ aux.FECHA_HORA }}">Calculando...</span>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li style="justify-content: center;" class="text-muted fst-italic">No hay auxiliares activos.</li>
                    {% endif %}
                </ul>
            </div>

             <div class="card grid-col-span-2">
                <h3><i class="fas fa-history"></i> Préstamos Recientes (Hoy)</h3>
                <div class="table-wrapper">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>ID Vale</th>
                                <th>Hora</th>
                                <th>Alumno</th>
                                <th>No. Control</th>
                                <th>Auxiliar</th>
                                <th>Estatus</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if datos.prestamos_de_hoy %}
                                {% for prestamo in datos.prestamos_de_hoy %}
                                <tr>
                                    <td>{{ prestamo.ID_PRESTAMO }}</td>
                                    <td>{{ prestamo.FECHA_HORA[11:19] if prestamo.FECHA_HORA else 'N/A' }}</td>
                                    <td>{{ prestamo.ALUMNO }}</td>
                                    <td>{{ prestamo.NUMEROCONTROL }}</td>
                                    <td>{{ prestamo.AUXILIAR }}</td>
                                    <td>
                                        {% set status = prestamo.ESTATUS or 'Desconocido' %}
                                        <span class="status-dot {{ status }}"></span>
                                        {{ status }}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted fst-italic py-3">No se han registrado préstamos hoy.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-star"></i> Top 5 Materiales Más Pedidos</h3>
                <canvas id="topMaterialesChart"></canvas> {% if not datos.top_materiales_pedidos %}
                 <p class="text-center text-muted fst-italic mt-3">No hay datos suficientes para mostrar el gráfico.</p>
                {% endif %}
            </div>

             <div class="card">
                <h3><i class="fas fa-exclamation-triangle text-warning"></i> Préstamos Vencidos (+1 hora)</h3>
                {% if datos.prestamos_vencidos %}
                <ul class="list">
                    {% for item in datos.prestamos_vencidos %}
                    <li>
                        <span>{{ item.NOMBRE }} ({{ item.NUMEROCONTROL }})</span>
                        <span class="date">Inició: {{ item.FECHA_HORA[:16] if item.FECHA_HORA else 'N/A' }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted fst-italic">No hay préstamos vencidos actualmente.</p>
                {% endif %}
            </div>

            <div class="card">
                <h3><i class="fas fa-layer-group"></i> Top 5 Semestres (Préstamos)</h3>
                {% if datos.top_semestres %}
                <ul class="list">
                    {% for item in datos.top_semestres %}
                    <li><span>{{ item.SEMESTRE }}° Semestre</span> <span class="value">{{ item.TOTAL_PRESTAMOS }}</span></li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted fst-italic">No hay datos de préstamos.</p>
                {% endif %}
            </div>

            <div class="card">
                <h3><i class="fas fa-heart-broken text-danger"></i> Top 5 Materiales Dañados</h3>
                {% if datos.top_danos %}
                <ul class="list">
                    {% for item in datos.top_danos %}
                    <li><span>{{ item.NOMBRE }}</span> <span class="value">{{ item.TOTAL_DANADO }}</span></li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted fst-italic">No se han registrado daños.</p>
                {% endif %}
            </div>

            <div class="card">
                <h3><i class="fas fa-archive text-secondary"></i> Materiales Nunca Prestados</h3>
                {% if datos.stock_muerto %}
                <ul class="list" style="max-height: 200px; overflow-y: auto;"> {% for item in datos.stock_muerto %}
                    <li><span>{{ item.NOMBRE }}</span> <span class="value">Stock: {{ item.CANTIDAD_DISPONIBLE }}</span></li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted fst-italic">Todos los materiales han sido prestados.</p>
                {% endif %}
            </div>

            <div class="card">
                <h3><i class="fas fa-user-lock text-warning"></i> Logins Fallidos (Auxiliares)</h3>
                {% if datos.logins_fallidos %}
                <ul class="list">
                    {% for item in datos.logins_fallidos %}
                    <li><span>{{ item.USUARIO }}</span> <span class="value">{{ item.INTENTOS_FALLIDOS }} intentos</span></li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted fst-italic">No hay registros de intentos fallidos.</p>
                {% endif %}
            </div>

        </div> </main>
    <script>
        // --- INICIO LÓGICA JAVASCRIPT REPORTES ---

        // Función de inicialización
        function initializeReportesScripts() {
            
            // 1. Gráfico de Top Materiales Pedidos
            try { // Usar try-catch por si 'datos' no está bien formado
                const topMaterialesData = {{ datos.top_materiales_pedidos | default('[]') | tojson | safe }};
                const ctxTopMaterialesElement = document.getElementById('topMaterialesChart');
                
                if (ctxTopMaterialesElement && topMaterialesData && topMaterialesData.length > 0) {
                    const topMaterialesLabels = topMaterialesData.map(item => item.NOMBRE || 'Desconocido');
                    const topMaterialesValues = topMaterialesData.map(item => item.TOTAL || 0);

                    // Destruir gráfico anterior si existe (importante para recargas AJAX)
                    const existingChart = Chart.getChart(ctxTopMaterialesElement);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    // Crear nuevo gráfico
                    new Chart(ctxTopMaterialesElement.getContext('2d'), {
                        type: 'doughnut', // O 'pie'
                        data: {
                            labels: topMaterialesLabels,
                            datasets: [{
                                label: 'Total Pedido',
                                data: topMaterialesValues,
                                backgroundColor: [ // Colores de ejemplo
                                    '#0d6efd', '#6f42c1', '#d63384', '#fd7e14', '#198754' 
                                ],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // Permitir que se ajuste mejor
                            plugins: {
                                legend: { position: 'bottom' }, // Leyenda abajo
                                tooltip: { enabled: true }
                            }
                        }
                    });
                } else if (ctxTopMaterialesElement) {
                     // Opcional: Mostrar mensaje si no hay datos en lugar del canvas vacío
                     // ctxTopMaterialesElement.style.display = 'none'; // Oculta el canvas
                     // O podrías añadir un P con el mensaje desde JS
                }
            } catch (e) {
                console.error("Error al renderizar gráfico Top Materiales:", e);
                const chartElement = document.getElementById('topMaterialesChart');
                if (chartElement) chartElement.outerHTML = '<p class="text-danger text-center">Error al cargar gráfico.</p>';
            }

            // 2. Timers de Auxiliares Activos (Función global para ser llamada por setInterval)
            window.updateAllTimers = function() {
                const timerElements = document.querySelectorAll('.timer[data-login-time]');
                timerElements.forEach(timerElement => {
                    const loginTimeString = timerElement.getAttribute('data-login-time');
                    if (!loginTimeString) return;
                    try {
                        const loginTime = new Date(loginTimeString.replace(' ', 'T'));
                        const now = new Date();
                        const elapsedSeconds = Math.floor((now - loginTime) / 1000);

                        if (isNaN(elapsedSeconds) || elapsedSeconds < 0) {
                             timerElement.textContent = "Error"; return;
                        }

                        const hours = Math.floor(elapsedSeconds / 3600);
                        const minutes = Math.floor((elapsedSeconds % 3600) / 60);
                        const seconds = elapsedSeconds % 60;
                        timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    } catch (e) {
                         console.error("Error calculando timer para:", loginTimeString, e);
                         timerElement.textContent = "Error";
                    }
                });
            }

            // Limpiar intervalo anterior si existe (importante para recargas AJAX)
            if (window.timerIntervalId) {
                clearInterval(window.timerIntervalId);
            }
            // Iniciar nuevo intervalo y guardar su ID
            window.timerIntervalId = setInterval(window.updateAllTimers, 1000);
            
            // Ejecutar una vez al inicio
            window.updateAllTimers();

        } // Fin initializeReportesScripts

        // Ejecutar scripts al cargar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeReportesScripts);
        } else {
            initializeReportesScripts();
        }
        // --- FIN LÓGICA JAVASCRIPT ---
    </script>
</body>
</html>


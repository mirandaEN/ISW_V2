{% extends "base_dashboard.html" %}

{% block title %}Registro de Préstamos{% endblock %}

{% block page_styles %}
<style>
    .modal {
        display: none; /* Oculto por defecto */
        position: fixed; /* Posición fija */
        z-index: 1055; /* Encima de otros elementos (Bootstrap usa 1050) */
        left: 0;
        top: 0;
        width: 100%; /* Ancho completo */
        height: 100%; /* Alto completo */
        overflow: auto; /* Scroll si el contenido es muy largo */
        background-color: rgba(0,0,0,0.5); /* Fondo semitransparente */
        /* Añadir padding para centrar mejor el contenido */
        padding-top: 50px; 
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto; /* Centrado vertical (aproximado) y horizontal */
        padding: 25px; /* Más padding interno */
        border: 1px solid #ddd;
        border-radius: 8px; /* Bordes redondeados */
        width: 90%; /* Ancho relativo */
        max-width: 550px; /* Ancho máximo fijo */
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Sombra más definida */
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 15px; /* Más espacio */
        margin-bottom: 20px; /* Espacio antes del formulario */
        /* Quitar fondo amarillo, hacerlo estándar */
        background-color: transparent; 
        color: #333; /* Texto oscuro */
    }
    .modal-header h2 { margin: 0; font-size: 1.4em; color: #dc3545; /* Título en rojo */}
    .close {
        color: #555; font-size: 1.5rem; /* Tamaño ajustado */
        font-weight: bold; cursor: pointer; background: none; border: none;
        padding: 0.5rem 1rem; /* Área de clic más grande */
        line-height: 1;
    }
    .close:hover { color: #000; }
    /* SOLO estilos MUY específicos de esta página */
    :root {
        --prestamos-color-principal: #7d0015; 
        --prestamos-color-secundario: #a71d2a; 
        --prestamos-color-activo: #28a745; 
        --prestamos-color-devuelto: #6c757d; 
    }
    
    /* --- AJUSTES DE DISEÑO --- */
    main#prestamosContent {
        padding: 0; /* Padding general */
    }
    .content-wrapper-centered { /* Contenedor interno */
        /* Definimos un ancho razonable para que se vea bien en pantallas grandes */
        max-width: 1250px; 
        /* Centrar el contenido dentro del área blanca del main */
        margin: 20px auto; 
        /* Añadir padding interno para que no se pegue a los bordes de este contenedor */
        padding: 1.5rem; /* Aseguramos que no haya margen derecho extra */
    }
    .main-title { /* Título principal */
        font-weight: 700;
        color: #343a40; 
        font-size: 1.8em; 
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
        text-align: center; /* Centrar el título */
    }
    /* --- FIN AJUSTES --- */

    .btn-principal { background-color: var(--prestamos-color-principal) !important; /* ... etc ... */ }
    .btn-principal:hover { background-color: var(--prestamos-color-secundario) !important; }
    .card-section { /* ... estilos sin cambios ... */ }
    #listaMaterialSeleccionado li { /* ... estilos sin cambios ... */ }
    .materials-table-container { /* ... estilos sin cambios ... */ }
    .status-badge { /* ... estilos sin cambios ... */ }
    .status-badge.activo { /* ... */ }
    .status-badge.devuelto { /* ... */ }
    .error-message { /* ... estilos sin cambios ... */ }
    input.invalid + .error-message, input:invalid + .error-message { /* ... */ }
    input.invalid, input:invalid { /* ... */ }
    .filter-container { /* ... estilos sin cambios ... */ }
    .filter-container label { /* ... */ }
    .modal { /* ... estilos sin cambios ... */ }
    .modal-content { /* ... */ }
    .modal-header { /* ... */ }
    .modal-header h2 { /* ... */ }
    .close { /* ... */ }
    .form-group { /* ... */ }
    .form-group label { /* ... */ }
    .form-group input, .form-group textarea, .form-group select { /* ... */ }
     .flash-messages-local { /* ... */ }
</style>
{% endblock %}

{% block content %}
    <div class="flash-messages-local">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <h2 class="main-title mb-4"><i class="fas fa-exchange-alt me-2"></i>Registro y Gestión de Préstamos</h2>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card-section">
                <h5><i class="fas fa-file-invoice"></i> Nuevo Préstamo</h5>
                <hr>
                <form id="formNuevoPrestamo" method="POST" action="{{ url_for('registrar_prestamo') }}">
                    <input type="hidden" name="materiales_seleccionados" id="materialesSeleccionadosInput">
                    <div class="mb-3">
                        <label for="noControl" class="form-label">No. de Control del Alumno *</label>
                        <input type="text" class="form-control" id="noControl" name="no_control" placeholder="Ej: 22050751 o C22050751"
                               required pattern="^([A-Z]\d{8}|\d{8})$" maxlength="9"
                               title="Formato: 8 números o 1 letra y 8 números.">
                        <span id="noControl-error" class="error-message">Formato inválido.</span>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="nombreAlumno" class="form-label">Nombre del Alumno</label>
                            <input type="text" class="form-control" id="nombreAlumno" name="nombre_alumno" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="semestre" class="form-label">Semestre</label>
                            <input type="text" class="form-control" id="semestre" name="semestre" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="materia" class="form-label">Materia *</label>
                            <select class="form-select" id="materia" name="materia" required>
                                <option value="" selected disabled>Selecciona...</option>
                                {% for materia in materias %}
                                <option value="{{ materia.ID_MATERIA }}">{{ materia.NOMBRE_MATERIA }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="maestro" class="form-label">Maestro *</label>
                            <select class="form-select" id="maestro" name="maestro" required>
                                <option value="" selected disabled>Selecciona...</option>
                                {% for maestro in maestros %}
                                <option value="{{ maestro.ID_MAESTRO }}">{{ maestro.NOMBRE_COMPLETO }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mesa" class="form-label">No. de Mesa</label>
                            <input type="number" class="form-control" id="mesa" name="mesa" min="1">
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="auxiliar" class="form-label">Auxiliar</label>
                            <input type="text" class="form-control" id="auxiliar" value="{{ session.user_nombre }}" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Materiales Seleccionados:</h6>
                        <ul id="listaMaterialSeleccionado" class="list-unstyled bg-light p-2 rounded" style="min-height: 50px;">
                           <li id="placeholder-material" class="text-muted fst-italic">Aún no has agregado material.</li>
                        </ul>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-principal">Registrar Préstamo</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card-section">
                <h5><i class="fas fa-boxes"></i> Material Disponible</h5>
                <hr>
                <div class="filter-container">
                    <label class="fw-bold me-2">Buscar por:</label>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="filtroId" value="id" checked><label class="form-check-label" for="filtroId">ID</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="filtroNombre" value="nombre" checked><label class="form-check-label" for="filtroNombre">Nombre</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="filtroTipo" value="tipo"><label class="form-check-label" for="filtroTipo">Tipo</label></div>
                    <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="filtroMarca" value="marca"><label class="form-check-label" for="filtroMarca">Marca/Modelo</label></div>
                </div>
                <div class="input-group mb-3">
                    <input type="text" id="busquedaMaterial" class="form-control" placeholder="Buscar material...">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
                <div class="materials-table-container">
                    <table class="table table-hover table-sm"> <thead class="table-light"> <tr><th>Nombre</th><th>Disp.</th><th>Acción</th></tr>
                        </thead>
                        <tbody id="tablaMaterialesBody">
                            {% for material in materiales_disponibles %}
                            <tr data-id="{{ material.ID_MATERIAL }}" data-nombre="{{ material.NOMBRE or '' }}" data-tipo="{{ material.TIPO or '' }}" data-marca="{{ material.MARCA_MODELO or '' }}" data-disponibles="{{ material.CANTIDAD_DISPONIBLE }}">
                                <td>{{ material.NOMBRE }}</td>
                                <td>{{ material.CANTIDAD_DISPONIBLE }}</td>
                                <td><button class="btn btn-sm btn-success btn-agregar-material" title="Agregar"><i class="fas fa-plus"></i></button></td>
                            </tr>
                            {% endfor %}
                            {% if not materiales_disponibles %}
                            <tr><td colspan="3" class="text-center text-muted fst-italic py-3">No hay materiales con stock.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
             <div class="card-section">
                <h4 class="main-title"><i class="fas fa-history me-2"></i>Préstamos Activos del Día</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                            <tr><th>Vale</th><th>Alumno</th><th>Materiales</th><th>Fecha/Hora</th><th>Estado</th><th>Acción</th></tr>
                        </thead>
                        <tbody>
                            {% for prestamo in prestamos_activos %}
                            <tr data-id-prestamo="{{ prestamo.ID_PRESTAMO }}">
                                <td>{{ prestamo.ID_PRESTAMO }}</td>
                                <td>{{ prestamo.NUMEROCONTROL }} - {{ prestamo.NOMBRE }}</td>
                                <td>{{ prestamo.MATERIALES_LISTA }}</td>
                                <td>{{ prestamo.FECHA_HORA_DISPLAY or prestamo.FECHA_HORA }}</td>
                                <td><span class="status-badge activo">Activo</span></td>
                                <td class="text-nowrap">
                                    <button class="btn btn-sm btn-outline-warning btn-reportar-dano"
                                            data-id-prestamo="{{ prestamo.ID_PRESTAMO }}"
                                            onclick="openDanoModal(this)" title="Reportar Daño">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </button>
                                    <form method="POST" action="{{ url_for('devolver_prestamo') }}" style="display:inline;">
                                        <input type="hidden" name="id_prestamo" value="{{ prestamo.ID_PRESTAMO }}">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary" title="Devolver Material">
                                            <i class="fas fa-undo-alt"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not prestamos_activos %}
                            <tr><td colspan="6" class="text-center text-muted fst-italic py-3">No hay préstamos activos hoy.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
             </div>
        </div>
    </div>

    <div id="danoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Reportar Daño</h2>
                <button type="button" class="close" onclick="closeModal('danoModal')">&times;</button>
            </div>
            <form action="{{ url_for('registrar_dano') }}" method="POST">
                <input type="hidden" id="dano_id_prestamo" name="id_prestamo">
                <div class="form-group">
                    <label for="dano_material">Material Dañado</label>
                    <select id="dano_material" name="id_material" class="form-select" required>
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dano_cantidad">Cantidad Dañada</label>
                    <input type="number" id="dano_cantidad" name="cantidad_danada" class="form-control" min="1" required>
                </div>
                <div class="form-group">
                    <label for="dano_motivo">Motivo del Daño *</label>
                    <textarea id="dano_motivo" name="motivo" class="form-control" rows="3" required></textarea>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-danger btn-principal">Registrar Daño</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
<script>
    // --- INICIO LÓGICA JAVASCRIPT DE PRESTAMOS (v4.3 - Refined Init & Click) ---

    // Variables globales (se reinician en initialize)
    let materialesSeleccionados = {};
    let materialesDisponiblesData = {};

    // --- Funciones Globales ---
    window.buscarAlumno = function() {
        console.log(">>> [buscarAlumno] Iniciando búsqueda...");
        const noControlInput = document.getElementById('noControl');
        const nombreAlumnoInput = document.getElementById('nombreAlumno');
        const semestreInput = document.getElementById('semestre');

        if (!noControlInput || !nombreAlumnoInput || !semestreInput) {
            console.error(">>> [buscarAlumno] Error: Elementos del formulario no encontrados.");
            return;
        }
        const noControl = noControlInput.value.trim();
        console.log("   - Buscando No. Control:", noControl);

        if (noControl && noControlInput.checkValidity()) {
            nombreAlumnoInput.value = 'Buscando...';
            semestreInput.value = '';
            fetch(`/api/alumno/${noControl}`)
                .then(response => {
                    console.log("   - Respuesta Fetch recibida, status:", response.status);
                    if (!response.ok) {
                         return response.json().then(errData => {
                             throw new Error(errData.error || `Error ${response.status}: ${response.statusText}`);
                         }).catch(() => { throw new Error(`Error ${response.status}: ${response.statusText}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("   - Datos recibidos (JSON):", data);
                    if (data.error) {
                        alert(data.error);
                        window.limpiarDatosAlumno();
                    } else {
                        if (data.hasOwnProperty('NOMBRE') && data.hasOwnProperty('SEMESTRE')) {
                            nombreAlumnoInput.value = data.NOMBRE || '';
                            semestreInput.value = data.SEMESTRE || '';
                            console.log("   - Campos actualizados.");
                        } else {
                             console.error(">>> [buscarAlumno] Error: Respuesta JSON no tiene NOMBRE o SEMESTRE.", data);
                             alert("Error: La respuesta del servidor no tiene el formato esperado.");
                             window.limpiarDatosAlumno();
                        }
                    }
                })
                .catch(error => {
                    console.error('>>> [buscarAlumno] Error en fetch o procesamiento:', error);
                    alert(error.message || 'Error en la conexión al buscar alumno.');
                    window.limpiarDatosAlumno();
                });
        } else {
             console.warn(">>> [buscarAlumno] No. Control inválido, no se busca.");
             const noControlError = document.getElementById('noControl-error');
             if (noControlError) { noControlError.textContent = 'Formato inválido.'; noControlError.style.display = 'block'; }
        }
     }; // Fin buscarAlumno

    window.limpiarDatosAlumno = function(){
        const nombreInput = document.getElementById('nombreAlumno');
        const semestreInput = document.getElementById('semestre');
        if (nombreInput) nombreInput.value = '';
        if (semestreInput) semestreInput.value = '';
    }; // Fin limpiarDatosAlumno

    window.openDanoModal = function(button) {
        const idPrestamo = button.getAttribute('data-id-prestamo');
        const danoIdPrestamoInput = document.getElementById('dano_id_prestamo');
        const danoMaterialSelect = document.getElementById('dano_material');
        const danoCantidadInput = document.getElementById('dano_cantidad');

        if (!danoIdPrestamoInput || !danoMaterialSelect || !danoCantidadInput) {
            console.error("openDanoModal: Elementos no encontrados.");
            return;
        }

        danoIdPrestamoInput.value = idPrestamo;
        danoMaterialSelect.innerHTML = '<option value="">Cargando...</option>';
        danoMaterialSelect.disabled = true;
        danoCantidadInput.value = 1;
        danoCantidadInput.max = 1;

        fetch(`/api/prestamo/${idPrestamo}/materiales`)
            .then(response => {
                if (response.status === 404) return response.json().then(err => { throw new Error(err.error || 'No hay materiales activos.'); });
                if (!response.ok) throw new Error('Error al obtener materiales.');
                return response.json();
            })
            .then(materiales => {
                danoMaterialSelect.innerHTML = '<option value="" selected disabled>Selecciona...</option>';
                if (materiales && materiales.length > 0) {
                    materiales.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.ID_MATERIAL;
                        option.textContent = `${m.NOMBRE} (Act: ${m.CANTIDAD_PRESTADA})`;
                        option.dataset.max = m.CANTIDAD_PRESTADA;
                        danoMaterialSelect.appendChild(option);
                    });
                    danoMaterialSelect.disabled = false;
                    window.openModal('danoModal'); // Llama a función global
                } else {
                    throw new Error('No se encontraron materiales activos.');
                }
            })
            .catch(error => {
                console.error('Error modal daño:', error);
                alert(error.message || 'No se pudo cargar lista.');
            });
    }; // Fin openDanoModal

    window.actualizarListaVisual = function() {
        const listaEl = document.getElementById('listaMaterialSeleccionado');
        const inputEl = document.getElementById('materialesSeleccionadosInput');
        const placeholderEl = document.getElementById('placeholder-material');
        const tablaBodyEl = document.getElementById('tablaMaterialesBody');

        if (!listaEl || !inputEl || !tablaBodyEl) {
             console.error("actualizarListaVisual: Elementos necesarios no encontrados.");
             return;
        }

        listaEl.innerHTML = '';
        let hayMaterial = false;

        for (const id in materialesSeleccionados) {
            const cantidad = materialesSeleccionados[id];
            if (cantidad > 0) {
                hayMaterial = true;
                const filaMaterial = tablaBodyEl.querySelector(`tr[data-id='${id}']`);
                const nombre = filaMaterial ? filaMaterial.dataset.nombre : `ID ${id}`;
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${nombre} <strong>(x${cantidad})</strong></span>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-quitar-material" data-id="${id}">Quitar</button>
                `;
                listaEl.appendChild(li);
            }
        }

        if (placeholderEl) {
            placeholderEl.style.display = hayMaterial ? 'none' : 'list-item';
        }

        inputEl.value = JSON.stringify(materialesSeleccionados);
     }; // Fin actualizarListaVisual

    window.filtrarMateriales = function() {
        console.log(">>> [Handler] Filtrando materiales...");
        const busquedaInput = document.getElementById('busquedaMaterial');
        const checkboxes = document.querySelectorAll('.filter-container .form-check-input');
        const tablaBody = document.getElementById('tablaMaterialesBody');

        if (!busquedaInput || !checkboxes || !tablaBody) {
            console.error("filtrarMateriales: Elementos clave no encontrados.");
            return;
        }

        const filtroTexto = busquedaInput.value.toUpperCase().trim();
        const filtrosActivos = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        const filas = tablaBody.getElementsByTagName('tr');

        console.log(`   - Texto a buscar: "${filtroTexto}"`);
        console.log(`   - Filtros activos: [${filtrosActivos.join(', ')}]`);

        let algunaFilaVisible = false;

        for (let i = 0; i < filas.length; i++) {
            const fila = filas[i];
            if (!fila.dataset.id) { if (fila.querySelector('td[colspan]')) { fila.style.display = 'none'; } continue; }

            let mostrarFila = false;
            if (filtroTexto === '') { mostrarFila = true; }
            else {
                let columnasABuscar = (filtrosActivos.length > 0) ? filtrosActivos : ['id', 'nombre'];
                for (const columna of columnasABuscar) {
                    const textoCelda = (fila.dataset[columna] || '').toUpperCase();
                    if (textoCelda.includes(filtroTexto)) { mostrarFila = true; break; }
                }
            }
             console.log(`      - Fila ${fila.dataset.id}: ${mostrarFila ? 'Mostrar' : 'Ocultar'} (Resultado búsqueda).`);
            fila.style.display = mostrarFila ? "" : "none";
            if (mostrarFila) algunaFilaVisible = true;
        }
        console.log("   - Filtro completado.");
    }; // Fin filtrarMateriales

    window.openModal = function(modalId) { const m=document.getElementById(modalId); if(m){ try { bootstrap.Modal.getOrCreateInstance(m).show(); } catch(e){ console.warn("Fallback openModal"); m.style.display="block";}} };
    window.closeModal = function(modalId) { const m=document.getElementById(modalId); if(m){ try { const i=bootstrap.Modal.getInstance(m); if(i) i.hide(); else m.style.display="none"; } catch(e){ console.warn("Fallback closeModal"); m.style.display="none";}} };

    // --- Funciones Handler ---
    function handleNoControlInput(event) {
        const input = event.target; const errorSpan = document.getElementById('noControl-error'); input.value = input.value.toUpperCase();
        if (input.checkValidity()) { input.classList.remove('invalid'); if (errorSpan) errorSpan.style.display = 'none'; }
        else { input.classList.add('invalid'); if (errorSpan) { errorSpan.textContent = 'Inválido'; errorSpan.style.display = 'block'; } window.limpiarDatosAlumno(); }
    }
    function handleNoControlEnter(event) {
        console.log(">>> [Handler] Enter presionado en No. Control");
        if (event.key === 'Enter') {
            event.preventDefault();
            const esValido = event.target.checkValidity();
            console.log("   - checkValidity() =", esValido);
            if (esValido) { window.buscarAlumno(); }
            else { const e = document.getElementById('noControl-error'); if(e) { e.textContent = 'Inválido'; e.style.display = 'block'; } }
        }
    }
    function handleDanoMaterialChange(event) {
        console.log(">>> [Handler] Cambió Select Daño");
        const select = event.target; const cantidadInput = document.getElementById('dano_cantidad'); const selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.dataset.max && cantidadInput) {
            const maxCant = parseInt(selectedOption.dataset.max, 10); cantidadInput.max = maxCant; cantidadInput.value = (maxCant > 0) ? 1 : 0;
            if (maxCant <= 0) { alert("No hay unidades activas."); }
        }
    }
    function handleAgregarMaterialClick(event) {
        console.log(">>> [Handler] Click detectado en tabla. Target:", event.target);
        const button = event.target.closest('.btn-agregar-material');
        if (button) {
            console.log("   - Click fue en botón Agregar (+) o su icono.");
            const fila = button.closest('tr');
            if (!fila) { console.error("   - Error Crítico: No se encontró la fila (tr)."); return; }
            console.log("   - Fila encontrada:", fila);

            const id = fila.dataset.id; const nombre = fila.dataset.nombre;
            const maxDisponiblesAttr = fila.dataset.disponibles;
            const maxDisponibles = parseInt(maxDisponiblesAttr, 10);
            const cantidadSeleccionada = materialesSeleccionados[id] || 0;

            if (isNaN(maxDisponibles)) { console.error(`   - Error Crítico: No se pudo parsear data-disponibles ('${maxDisponiblesAttr}') para ID ${id}.`); alert("Error al leer stock."); return; }
            console.log(`   - Datos: ID=${id}, Nombre=${nombre}, MaxDisp=${maxDisponibles}, YaSelecc=${cantidadSeleccionada}`);

            if (cantidadSeleccionada >= maxDisponibles) { alert(`No hay más stock para "${nombre}". (${cantidadSeleccionada}/${maxDisponibles})`); console.warn(`   - Intento fallido (Sin stock): ID=${id}`); return; }

            const cantidadRestante = maxDisponibles - cantidadSeleccionada;
            console.log("   - Mostrando prompt...");
            const cantidadInput = prompt(`¿Cantidad de "${nombre}" a agregar? (Disp: ${cantidadRestante})`, 1);
            console.log(`   - Prompt devolvió: "${cantidadInput}"`);

            if (cantidadInput !== null && cantidadInput.trim() !== "") {
                 const cantidad = parseInt(cantidadInput, 10);
                 console.log(`   - Cantidad parseada: ${cantidad}`);
                 if (!isNaN(cantidad) && cantidad > 0 && cantidad <= cantidadRestante) {
                     materialesSeleccionados[id] = cantidadSeleccionada + cantidad;
                     console.log(`   - 'materialesSeleccionados' actualizado:`, JSON.stringify(materialesSeleccionados));
                     console.log("   - Llamando a actualizarListaVisual()...");
                     window.actualizarListaVisual();
                     console.log("   - actualizarListaVisual() llamado.");
                 } else { alert('Cantidad inválida o excede stock.'); console.warn(`   - Cantidad inválida (${cantidad}) vs restante (${cantidadRestante}).`); }
            } else { console.log("   - Prompt cancelado o vacío."); }
        }
    } // Fin handleAgregarMaterialClick
    function handleQuitarMaterialClick(event) {
         if (event.target && event.target.classList.contains('btn-quitar-material')) {
            console.log(">>> [Handler] Click Botón Quitar Material");
            const id = event.target.dataset.id; delete materialesSeleccionados[id]; window.actualizarListaVisual();
        }
    }

    // --- Función de Inicialización Principal ---
    function initializePrestamosScripts() {
         console.log("✅ Inicializando scripts de Préstamos (v4.3 - Refined Init)...");
         materialesSeleccionados = {};

         const noControlInput = document.getElementById('noControl');
         const tablaMaterialesBody = document.getElementById('tablaMaterialesBody');
         const listaMaterialSeleccionado = document.getElementById('listaMaterialSeleccionado');
         const busquedaMaterialInput = document.getElementById('busquedaMaterial');
         const danoMaterialSelect = document.getElementById('dano_material');
         const checkboxesFiltro = document.querySelectorAll('.filter-container .form-check-input');

         // --- LIMPIAR LISTENERS ANTIGUOS ---
         if (noControlInput) { noControlInput.removeEventListener('input', handleNoControlInput); noControlInput.removeEventListener('keypress', handleNoControlEnter); }
         if (danoMaterialSelect) { danoMaterialSelect.removeEventListener('change', handleDanoMaterialChange); }
         if (tablaMaterialesBody) { tablaMaterialesBody.removeEventListener('click', handleAgregarMaterialClick); }
         if (listaMaterialSeleccionado) { listaMaterialSeleccionado.removeEventListener('click', handleQuitarMaterialClick); }
         if (busquedaMaterialInput) { busquedaMaterialInput.removeEventListener('keyup', window.filtrarMateriales); }
         if (checkboxesFiltro) { checkboxesFiltro.forEach(cb => cb.removeEventListener('change', window.filtrarMateriales)); }
         console.log("   - Listeners previos removidos (si existían).");

         // --- AÑADIR NUEVOS LISTENERS ---
         if (noControlInput) { console.log("   - Configurando listeners No. Control"); noControlInput.addEventListener('input', handleNoControlInput); noControlInput.addEventListener('keypress', handleNoControlEnter); } else { console.warn("..."); }
         if (danoMaterialSelect) { console.log("   - Configurando listener Select Daño"); danoMaterialSelect.addEventListener('change', handleDanoMaterialChange); } else { console.warn("..."); }
         if (tablaMaterialesBody) { console.log("   - Configurando listener Tabla Materiales (Agregar)"); tablaMaterialesBody.addEventListener('click', handleAgregarMaterialClick); } else { console.warn("..."); }
         if (listaMaterialSeleccionado) { console.log("   - Configurando listener Lista Seleccionados (Quitar)"); listaMaterialSeleccionado.addEventListener('click', handleQuitarMaterialClick); } else { console.warn("..."); }
         if (busquedaMaterialInput) { console.log("   - Configurando listener Input Búsqueda"); busquedaMaterialInput.addEventListener('keyup', window.filtrarMateriales); } else { console.warn("..."); }
         if (checkboxesFiltro) { console.log("   - Configurando listeners Checkboxes Filtro"); checkboxesFiltro.forEach(cb => cb.addEventListener('change', window.filtrarMateriales)); } else { console.warn("..."); }

         // Llamadas iniciales
         window.actualizarListaVisual();
         window.filtrarMateriales();
         console.log("   - Inicialización completada (v4.3).");
    } // Fin initializePrestamosScripts

    // Ejecutar scripts:
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePrestamosScripts);
    } else {
        setTimeout(initializePrestamosScripts, 50); // Pequeño delay post-carga
    }
    // --- FIN LÓGICA PRESTAMOS ---
</script>
{% endblock %}
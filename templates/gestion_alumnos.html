<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/stile_inadmin.css') }}">
    <title>Gestión de Alumnos - LabFlow</title>
</head>
<body> 
    <nav class="navbar navbar-expand-lg navbar-custom-guindo sticky-top shadow-sm">
        <div class="container-fluid">
          
          <a class="navbar-brand fw-bold" href="{{ url_for('interface_admin') }}">
              <i class="fas fa-flask me-1"></i>
              Gestión Laboratorio
          </a>
          
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          
          <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('interface_admin') }}">Inicio</a>
                  </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('prestamos') }}">Préstamos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('inventario') }}">Inventario</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('gestion_danos') }}">Daños</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('gestion_auxiliares') }}">Auxiliares</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('soporte') }}">Soporte</a>
              </li>
              <li class="nav-item">
                <a class="nav-link"  href="{{ url_for('reportes') }}">Reportes</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="{{ url_for('gestion_alumnos') }}">Alumnos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('mostrar_dashboard') }}">Predicciones</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      
      <main class="container-fluid main-content" id="gestionAlumnosContent" style="max-width: 1400px; margin: 20px auto;"> <h2 class="mb-4"><i class="fas fa-user-graduate me-2"></i>Gestión de Alumnos</h2>

        <div class="flash-messages-container-local">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark"> <tr>
                                <th>Nombre</th>
                                <th>N° Control</th>
                                <th>Correo</th>
                                <th>Carrera</th>
                                <th>Sem.</th>
                                <th>Estatus</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alumno in alumnos %}
                            <tr>
                                <td>{{ alumno.NOMBRE }}</td>
                                <td>{{ alumno.NUMEROCONTROL }}</td>
                                <td>{{ alumno.CORREO }}</td>
                                <td>{{ alumno.ESPECIALIDAD }}</td>
                                <td>{{ alumno.SEMESTRE }}</td>
                                <td>
                                    {% if alumno.ACTIVO == 1 %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalModificarAlumno"
                                            data-id="{{ alumno.ID_ALUMNO }}"
                                            data-nombre="{{ alumno.NOMBRE }}"
                                            data-nc="{{ alumno.NUMEROCONTROL }}"
                                            data-correo="{{ alumno.CORREO }}"
                                            data-carrera="{{ alumno.ESPECIALIDAD }}"
                                            data-semestre="{{ alumno.SEMESTRE }}">
                                        <i class="fas fa-edit"></i> Modificar
                                    </button>

                                    <form action="{{ url_for('desactivar_alumno') }}" method="POST" style="display: inline-block; margin-left: 5px;" class="form-desactivar">
                                        <input type="hidden" name="id_alumno" value="{{ alumno.ID_ALUMNO }}">

                                        {% if alumno.ACTIVO == 1 %}
                                            <button type="submit" class="btn btn-warning btn-sm" title="Desactivar Alumno" onclick="return confirm('¿Estás seguro de DESACTIVAR a este alumno? No podrá solicitar préstamos.');">
                                                <i class="fas fa-user-slash"></i>
                                            </button>
                                        {% else %}
                                            <button type="submit" class="btn btn-success btn-sm" title="Activar Alumno">
                                                <i class="fas fa-user-check"></i>
                                            </button>
                                        {% endif %}
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted fst-italic py-3">No hay alumnos registrados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="modalModificarAlumno" tabindex="-1" aria-labelledby="modalModificarLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white"> <h5 class="modal-title" id="modalModificarLabel">Modificar Alumno</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('modificar_alumno') }}" method="POST" novalidate id="formModificarAlumno">
                    <div class="modal-body">
                        <input type="hidden" id="modal-id_alumno" name="id_alumno">

                        <div class="mb-3">
                            <label for="modal-nombre" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="modal-nombre" name="nombre" required
                                   pattern="^[a-zA-Z\sñÑáéíóúÁÉÍÓÚ]+$"
                                   title="El nombre solo debe contener letras y espacios.">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modal-nc" class="form-label">Número de Control</label>
                                <input type="text" class="form-control" id="modal-nc" name="numero_control" required
                                       pattern="^([A-Z]\d{8}|\d{8})$"
                                       oninput="this.value = this.value.toUpperCase()"
                                       title="Formato: 8 dígitos (ej: 21040350) o 1 Letra + 8 dígitos (ej: L21040350).">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modal-correo" class="form-label">Correo Institucional</label>
                                <input type="email" class="form-control" id="modal-correo" name="correo" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modal-carrera" class="form-label">Carrera</label>
                                <select class="form-select" id="modal-carrera" name="carrera" required>
                                    <option value="">Selecciona tu carrera</option>
                                    <option value="ISC">Sistemas</option>
                                    <option value="II">Industrial</option>
                                    <option value="IG">Gestión</option>
                                    <option value="IM">Materiales</option>
                                    <option value="EL">Electrónica</option>
                                    <option value="MECA">Mecatrónica</option>
                                    <option value="ELEC">Eléctrica</option>
                                    <option value="MEC">Mecánica</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modal-semestre" class="form-label">Semestre</label>
                                <select class="form-select" id="modal-semestre" name="semestre" required>
                                    <option value="">Selecciona tu semestre</option>
                                    {% for i in range(1,14) %}
                                        <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="inactivityModal" tabindex="-1" aria-labelledby="inactivityModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inactivityModalLabel">Advertencia de Inactividad</h5>
                </div>
                <div class="modal-body">
                    <p>Tu sesión está a punto de expirar debido a inactividad.</p>
                    <p>Tiempo restante: <strong id="inactiveTimeLeft">60</strong> segundos.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="forceLogout()">Cerrar Sesión Ahora</button>
                    <button type="button" class="btn btn-primary" onclick="resetInactivityTimer()">Continuar Sesión</button>
                </div>
            </div>
        </div>
    </div>
    <div class="settings-fab-menu">
        <div class="settings-options">
            
            <button class="settings-option" id="btn-night-mode" title="Modo Noche">
                <i class="fas fa-moon"></i>
            </button>
    
            <a href="{{ url_for('profile') }}" class="settings-option" title="Perfil">
                <i class="fas fa-user"></i>
            </a>
            
            <a href="{{ url_for('logout') }}" class="settings-option" title="Cerrar Sesión">
                <i class="fas fa-sign-out-alt"></i>
            </a>
    
        </div>
    
        <button class="settings-main-btn" id="btn-settings-main" title="Ajustes">
            <i class="fas fa-cog"></i> </button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- INICIO LÓGICA JAVASCRIPT GESTION ALUMNOS ---

        // Función de inicialización
        function initializeGestionAlumnosScripts() {
            var modalModificar = document.getElementById('modalModificarAlumno');
            
            // Listener para llenar el modal
            if (modalModificar) {
                // Remover listener previo si existe para evitar duplicados
                modalModificar.removeEventListener('show.bs.modal', fillEditModal); 
                // Añadir el listener
                modalModificar.addEventListener('show.bs.modal', fillEditModal);
            }
        } // Fin initializeGestionAlumnosScripts

        // Función separada para llenar el modal
        function fillEditModal(event) {
            var button = event.relatedTarget;
            var id = button.getAttribute('data-id');
            var nombre = button.getAttribute('data-nombre');
            var nc = button.getAttribute('data-nc');
            var correo = button.getAttribute('data-correo');
            var carrera = button.getAttribute('data-carrera');
            var semestre = button.getAttribute('data-semestre');
            
            var modal = event.target; // El modal que disparó el evento
            modal.querySelector('#modal-id_alumno').value = id;
            modal.querySelector('#modal-nombre').value = nombre;
            modal.querySelector('#modal-nc').value = nc;
            modal.querySelector('#modal-correo').value = correo;
            modal.querySelector('#modal-carrera').value = carrera;
            modal.querySelector('#modal-semestre').value = semestre;
        }

        // Ejecutar scripts al cargar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGestionAlumnosScripts);
        } else {
            initializeGestionAlumnosScripts();
        }

        // --- FIN LÓGICA JAVASCRIPT ---
    </script>

    <script>
    // --- INICIO SCRIPT INACTIVIDAD (v2 - CON FIX GLOBAL DE MODALES) ---
    
    // --- 1. Configuración ---
    const inactivityLimitSeconds = {{ inactivity_limit | default(300) }};
    const warningTimeSeconds = 60; // Mostrar advertencia 60s antes
    
    // --- 2. Variables de estado ---
    let inactivityTimer; // Timer principal (largo)
    let warningTimer;    // Timer de cuenta regresiva (corto)
    let countdownValue;
    let inactivityModal; // Instancia del modal de Bootstrap
    let isWarningModalShown = false;
    
    // --- 3. Funciones principales ---
    
    // Inicializa la instancia del modal de BS (solo una vez)
    function initializeModalInstance() {
        if (!inactivityModal) {
            const modalEl = document.getElementById("inactivityModal");
            if (modalEl) {
                inactivityModal = new bootstrap.Modal(modalEl, {
                    backdrop: "static", // No se cierra al hacer clic fuera
                    keyboard: false    // No se cierra con 'Esc'
                });
            } else {
                console.error("Modal element #inactivityModal not found!");
            }
        }
    }
    
    // Reinicia el timer largo. Se llama con CUALQUIER actividad.
    function handleUserActivity() {
        clearTimeout(inactivityTimer); // Limpia el timer largo
        
        // Si el modal de advertencia estaba activo, lo esconde
        if (isWarningModalShown) {
            hideInactivityWarning();
        }
        
        // Inicia un NUEVO timer largo
        inactivityTimer = setTimeout(
            showInactivityWarning, // Función a llamar cuando termine
            (inactivityLimitSeconds - warningTimeSeconds) * 1000 // Tiempo de espera
        );
    }
    
    // Muestra el modal de advertencia e inicia la cuenta regresiva
    function showInactivityWarning() {
        isWarningModalShown = true;
        countdownValue = warningTimeSeconds;
        
        const timeLeftEl = document.getElementById("inactiveTimeLeft");
        if (!timeLeftEl) return;
        
        timeLeftEl.textContent = countdownValue;
        initializeModalInstance(); // Asegurarse de que esté listo
        
        if (!inactivityModal) return; // Salir si el modal no existe
        
        try {
            inactivityModal.show();
        } catch (e) {
            console.error("Error showing modal:", e);
            return;
        }
    
        // Inicia el timer corto (cuenta regresiva de 1s)
        clearInterval(warningTimer);
        warningTimer = setInterval(() => {
            countdownValue--;
            if (timeLeftEl) {
                timeLeftEl.textContent = countdownValue;
            }
            if (countdownValue <= 0) {
                forceLogout(); // Se acabó el tiempo
            }
        }, 1000);
    }
    
    // Esconde el modal de advertencia y detiene la cuenta regresiva
    function hideInactivityWarning() {
        if (isWarningModalShown && inactivityModal) {
            try {
                // Verificación de Bootstrap para evitar errores si ya está cerrado
                const modalEl = document.getElementById("inactivityModal");
                const instance = bootstrap.Modal.getInstance(modalEl);
                if (modalEl && instance && modalEl.classList.contains("show")) {
                    instance.hide();
                }
            } catch (e) {
                console.error("Error hiding modal:", e);
            }
        }
        isWarningModalShown = false;
        clearInterval(warningTimer); // Detiene la cuenta regresiva
    }
    
    // Se llama al presionar "Continuar Sesión"
    async function resetInactivityTimer() {
        hideInactivityWarning(); // Cierra el modal
        
        // Ping al servidor para mantener viva la sesión de Flask
        try {
            const response = await fetch("{{ url_for('keepalive') }}");
            if (!response.ok) {
                // Si el servidor dice que la sesión ya murió, nos vamos
                console.warn("Server session seems expired. Redirecting to login.");
                forceLogout();
                return;
            }
            // Si todo bien, reinicia el timer largo
            handleUserActivity(); 
        } catch (e) {
            console.error("Error calling keepalive:", e);
            handleUserActivity(); // Reinicia el timer localmente
        }
    }
    
    // Cierra la sesión
    function forceLogout() {
        clearTimeout(inactivityTimer);
        clearInterval(warningTimer);
        window.location.href = "{{ url_for('logout') }}?reason=inactivity";
    }
    
    // --- 4. Listeners de Actividad Base ---
    document.addEventListener("click", handleUserActivity, true);
    document.addEventListener("mousemove", handleUserActivity, true);
    document.addEventListener("keypress", handleUserActivity, true);
    document.addEventListener("scroll", handleUserActivity, true);
    
    // --- 5. Inicialización y FIX GLOBAL DE MODALES ---
    document.addEventListener("DOMContentLoaded", () => {
        initializeModalInstance(); // Prepara el modal de inactividad
        handleUserActivity();      // Inicia el primer timer
    
        // --- INICIO: GLOBAL MODAL FIX ---
        
        // Pausa el timer de inactividad si se abre CUALQUIER modal 
        // (que NO sea el de inactividad)
        document.addEventListener('show.bs.modal', function(e) {
            if (e.target.id !== 'inactivityModal') {
                console.log('GLOBAL: Pausando timer por modal:', e.target.id);
                clearTimeout(inactivityTimer); // Pausa el timer largo
                hideInactivityWarning(); // Cierra la advertencia si estaba abierta
            }
        });
    
        // Reanuda el timer (como si hubiera actividad) 
        // cuando CUALQUIER modal se cierra
        document.addEventListener('hidden.bs.modal', function(e) {
            // No necesitamos checar el ID, si CUALQUIER modal se cierra,
            // reiniciamos el conteo de actividad.
            console.log('GLOBAL: Reanudando timer por cierre de modal.');
            handleUserActivity();
        });
        // --- FIN: GLOBAL MODAL FIX ---
    });
    
    // --- FIN SCRIPT INACTIVIDAD ---
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- 1. REFERENCIAS A LOS ELEMENTOS ---
            const settingsMenu = document.querySelector('.settings-fab-menu');
            const settingsMainBtn = document.getElementById('btn-settings-main');
            const nightModeBtn = document.getElementById('btn-night-mode');
            const nightModeIcon = nightModeBtn.querySelector('i');
            const currentTheme = localStorage.getItem('theme'); // Revisa el tema guardado
    
            // --- 2. APLICAR TEMA AL CARGAR LA PÁGINA ---
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                nightModeIcon.classList.remove('fa-moon');
                nightModeIcon.classList.add('fa-sun'); // Pone el sol si ya está oscuro
            }
    
            // --- 3. LÓGICA PARA ABRIR/CERRAR EL MENÚ DE "BOLITAS" ---
            settingsMainBtn.addEventListener('click', function() {
                settingsMenu.classList.toggle('active');
            });
    
            // --- 4. LÓGICA PARA EL BOTÓN DE MODO NOCHE ---
            nightModeBtn.addEventListener('click', function() {
                // Activa/desactiva la clase en el BODY
                document.body.classList.toggle('dark-mode');
    
                // Guarda la preferencia en el navegador
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('theme', 'dark'); // Guardar como oscuro
                    nightModeIcon.classList.remove('fa-moon');
                    nightModeIcon.classList.add('fa-sun'); // Cambia a icono de sol
                } else {
                    localStorage.setItem('theme', 'light'); // Guardar como claro
                    nightModeIcon.classList.remove('fa-sun');
                    nightModeIcon.classList.add('fa-moon'); // Cambia a icono de luna
                }
            });
        });
    </script>
    </body>
</html>
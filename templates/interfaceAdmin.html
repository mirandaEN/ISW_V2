<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenido Administrador</title>
    <link rel="stylesheet" href="/static/css/stile_inadmin.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #inactivityModal .modal-header { background-color: #ffc107; color: #333; }
        /* Footer visible por defecto */
    </style>
</head>
<body>

    <header>
        <div class="menu container">
            <a href="{{ url_for('interface_admin') }}" class="logo">Instituto Tecnol贸gico de Saltillo</a>
            <input type="text" id="menu">
            <label for="menu"> <img src="/static/sources/menu.png" class="menu-icono" alt=""></label>
            <nav class="navbar">
                <ul>
                    <li><a href="{{ url_for('interface_admin') }}">Inicio</a></li>
                    <li><a href="{{ url_for('prestamos') }}">Prestamos</a></li>
                    <li><a href="{{ url_for('inventario') }}">Inventario</a></li>
                    <li><a href="{{ url_for('reportes') }}">Generar reportes</a></li>
                    <li><a href="{{ url_for('gestion_auxiliares') }}">Gesti贸n de auxiliares</a></li>
                    <li><a href="{{ url_for('gestion_danos') }}">Da帽os</a></li>
                </ul>
            </nav>
        </div>
        <div class="header-content container">
            <div class="content">
                <h1>Laboratorio de Electr贸nica / Anal贸gica</h1>
                <p>Bienvenido Administrador </p>
                <a href="{{ url_for('soporte') }}" class="btn-1">Contacto</a>
            </div>
            <img class="banner" src="/static/sources/itislogo.png" alt="">
        </div>
    </header>
    <main class="info container">
        <div class="box">
            <img src="/static/sources/prestamos.png" alt="">
            <h3>Prestamos</h3>
            <div class="description-content"><p>Este m贸dulo permite registrar, modificar y controlar el flujo de entrada y salida de todo el material solicitado por los alumnos.</p></div>
            <a href="{{ url_for('prestamos') }}" class="btn-1">IR</a>
        </div>
        <div class="box">
            <img src="/static/sources/inventario.png" alt="">
            <h3>Inventario</h3>
            <div class="description-content"><p>Accede al inventario central para dar de alta, modificar y eliminar materiales. Controla el stock total, disponible y da帽ado.</p></div>
            <a href="{{ url_for('inventario') }}" class="btn-1">IR</a>
        </div>
        <div class="box">
            <img src="/static/sources/reportes.png" alt="">
            <h3>Reportes</h3>
            <div class="description-content"><p>Muestra el panel de control con estad铆sticas de uso de material, actividad auxiliar, y los principales materiales solicitados y da帽ados.</p></div>
            <a href="{{ url_for('reportes') }}" class="btn-1">IR</a>
        </div>
        <div class="box">
            <img class="gestion" src="/static/sources/gestion-aux.png" alt="">
            <h3>Gesti贸n de Auxiliares</h3>
            <div class="description-content"><p>Administra las cuentas de los auxiliares de laboratorio. Puedes crear nuevos usuarios y gestionar el acceso y los permisos de inicio de sesi贸n.</p></div>
            <a href="{{ url_for('gestion_auxiliares') }}" class="btn-1">IR</a>
        </div>
        <div class="box">
            <img class="da帽o" src="/static/sources/chat_8532893.png" alt="">
            <h3>Da帽os</h3>
            <div class="description-content"> <p>Gestiona los registros de material da帽ado o extraviado. Permite marcar la reposici贸n por parte del alumno para actualizar el inventario total.</p></div>
            <a href="{{ url_for('gestion_danos') }}" class="btn-1">IR</a>
        </div>
    </main>

    <div class="logout-fixed">
        <a href="{{ url_for('logout') }}" class="btn-logout">Cerrar Sesi贸n</a>
    </div>

    <!-- Modal de Advertencia de Inactividad (CON BOTONES) -->
    <div class="modal fade" id="inactivityModal" tabindex="-1" aria-labelledby="inactivityModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inactivityModalLabel">Advertencia de Inactividad</h5>
                </div>
                <div class="modal-body">
                    <p>Tu sesi贸n est谩 a punto de expirar debido a inactividad.</p>
                    <p>Tiempo restante: <strong id="inactiveTimeLeft">60</strong> segundos.</p>
                    <p>Realiza alguna acci贸n (clic, mover mouse) o haz clic en "Continuar Sesi贸n" para evitar ser desconectado.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="forceLogout()">Cerrar Sesi贸n Ahora</button>
                    <button type="button" class="btn btn-primary" onclick="resetInactivityTimer()">Continuar Sesi贸n</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script Corregido v3: Timer de Inactividad (CON BOTONES Y RESET CORRECTO) -->
    <script>
        const inactivityLimitSeconds = {{ inactivity_limit | default(300) }};
        const warningTimeSeconds = 60;

        let inactivityTimer; // Timer principal (setTimeout)
        let warningTimer;    // Timer de cuenta regresiva del modal (setInterval)
        let countdownValue;  // Segundos restantes mostrados en el modal
        let inactivityModal; // Instancia del modal de Bootstrap
        let isWarningModalShown = false; // Flag para saber si el modal est谩 visible

        // Inicializa la instancia del modal de Bootstrap
        function initializeModalInstance() {
             if (!inactivityModal) {
                 const modalElement = document.getElementById('inactivityModal');
                 if(modalElement){
                     inactivityModal = new bootstrap.Modal(modalElement, {
                         backdrop: 'static', keyboard: false });
                 } else { console.error("Modal element #inactivityModal not found!"); }
            }
        }

        // Funci贸n principal que se llama con cualquier actividad del usuario
        function handleUserActivity() {
            // Siempre limpia el timer principal anterior
            clearTimeout(inactivityTimer);

            // Si el modal de advertencia estaba visible, oc煤ltalo
            if (isWarningModalShown) {
                //console.log("Activity detected while modal is shown. Hiding modal.");
                hideInactivityWarning();
                // OJO: No llamamos a keepalive aqu铆, la interacci贸n normal lo har谩 impl铆citamente al cargar la siguiente p谩gina o al hacer clic en botones que hagan requests.
                // Si la "actividad" es solo mover el mouse sin hacer clic en nada, no es necesario hacer un keepalive extra.
            }

            // Inicia/reinicia el timer principal que disparar谩 la advertencia
           // console.log("Resetting main inactivity timer.");
            inactivityTimer = setTimeout(showInactivityWarning, (inactivityLimitSeconds - warningTimeSeconds) * 1000);
        }


        // Muestra el modal de advertencia e inicia la cuenta regresiva
        function showInactivityWarning() {
           // console.log("Showing inactivity warning modal.");
            isWarningModalShown = true;
            countdownValue = warningTimeSeconds;

            const timeLeftElement = document.getElementById('inactiveTimeLeft');
            if(timeLeftElement) timeLeftElement.textContent = countdownValue;
            else return; // Salir si no se encuentra el elemento del contador

            initializeModalInstance(); // Asegura que la instancia exista
            if (inactivityModal) {
                try {
                    inactivityModal.show(); // Muestra el modal
                } catch(e) { console.error("Error showing modal:", e); return; }
            } else { return; } // Salir si el modal no se pudo inicializar

            clearInterval(warningTimer); // Limpia timer de cuenta regresiva anterior por si acaso
            warningTimer = setInterval(() => {
                countdownValue--;
                 if(timeLeftElement) timeLeftElement.textContent = countdownValue;
                if (countdownValue <= 0) {
                    forceLogout(); // Cierra sesi贸n si el contador llega a 0
                }
            }, 1000); // Actualiza cada segundo
        }

        // Oculta el modal y detiene la cuenta regresiva
        function hideInactivityWarning() {
            if (isWarningModalShown && inactivityModal) {
               // console.log("Hiding inactivity warning modal.");
                 try {
                     const modalElement = document.getElementById('inactivityModal');
                     const existingModalInstance = bootstrap.Modal.getInstance(modalElement);
                     // Solo oculta si la instancia existe Y el modal est谩 actualmente mostrado ('show')
                     if (modalElement && existingModalInstance && modalElement.classList.contains('show')) {
                          existingModalInstance.hide();
                     }
                 } catch (e) { console.error("Error hiding modal:", e); }
            }
             isWarningModalShown = false; // Marca como no visible
             clearInterval(warningTimer); // Detiene la cuenta regresiva
        }


        // Funci贸n llamada por el bot贸n "Continuar Sesi贸n"
        async function resetInactivityTimer() {
           // console.log("User clicked 'Continue Session'. Hiding modal, calling keepalive, resetting client timer.");
            hideInactivityWarning(); // Oculta el modal inmediatamente

             // Llama a /keepalive para resetear el timer del servidor Flask
             try {
                 const response = await fetch("{{ url_for('keepalive') }}");
                 if (!response.ok) {
                     // Si la respuesta no es OK (ej. 401 Unauthorized), la sesi贸n ya expir贸 en el servidor
                     console.warn("Server session seems expired. Redirecting to login.");
                     forceLogout(); // Redirige a logout
                     return; // No intentes reiniciar el timer local si fall贸
                 }
                 // Si keepalive fue exitoso, reinicia el timer del cliente expl铆citamente
                 //console.log("Keepalive successful. Restarting client timer.");
                 handleUserActivity(); // Llama a la funci贸n principal de actividad para reiniciar
             } catch (error) {
                 console.error("Error calling keepalive:", error);
                 // Como fallback, reinicia el timer local de todos modos
                 handleUserActivity();
             }
        }

        // Funci贸n para forzar el cierre de sesi贸n
        function forceLogout() {
           // console.log("Logging out due to inactivity or button press.");
            clearTimeout(inactivityTimer); // Limpia timer principal
            clearInterval(warningTimer);   // Limpia timer de advertencia
            // Redirige a la ruta de logout de Flask
            window.location.href = "{{ url_for('logout') }}?reason=inactivity";
        }

        // Eventos que detectan actividad del usuario y llaman a handleUserActivity
        document.addEventListener('click', handleUserActivity, true);
        document.addEventListener('mousemove', handleUserActivity, true);
        document.addEventListener('keypress', handleUserActivity, true);
        document.addEventListener('scroll', handleUserActivity, true);

        // Inicia el ciclo cuando la p谩gina carga
        document.addEventListener('DOMContentLoaded', () => {
             initializeModalInstance(); // Prepara la instancia del modal por si se necesita
             handleUserActivity();      // Inicia el primer timer
        });

    </script>

</body>
</html>



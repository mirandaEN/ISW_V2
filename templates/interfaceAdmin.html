<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador - LabFlow</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/stile_inadmin.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #inactivityModal .modal-header { background-color: #ffc107; color: #333; }
        /* Estilo para el spinner de carga */
        #mainContentArea .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body class="dashboard-layout"> <aside class="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('interface_admin') }}" class="logo-text">ITS</a>
        </div>
        <ul class="sidebar-nav">
            <li>
                <a href="{{ url_for('profile') }}" onclick="event.preventDefault(); loadContent('{{ url_for('profile') }}'); highlightActiveLink(this);">
                    <i class="fas fa-user-circle nav-icon"></i> Perfil
                </a>
            </li>
            <li>
                <a href="{{ url_for('prestamos') }}" onclick="event.preventDefault(); loadContent('{{ url_for('prestamos') }}'); highlightActiveLink(this);">
                    <i class="fas fa-exchange-alt nav-icon"></i> Pr茅stamos
                </a>
            </li>
            <li>
                <a href="{{ url_for('inventario') }}" onclick="event.preventDefault(); loadContent('{{ url_for('inventario') }}'); highlightActiveLink(this);">
                    <i class="fas fa-boxes nav-icon"></i> Inventario
                </a>
            </li>
            <li>
                <a href="{{ url_for('gestion_danos') }}" onclick="event.preventDefault(); loadContent('{{ url_for('gestion_danos') }}'); highlightActiveLink(this);">
                    <i class="fas fa-tools nav-icon"></i> Da帽os
                </a>
            </li>
             <li>
                <a href="{{ url_for('gestion_alumnos') }}" onclick="event.preventDefault(); loadContent('{{ url_for('gestion_alumnos') }}'); highlightActiveLink(this);">
                    <i class="fas fa-user-graduate nav-icon"></i> Gesti贸n Alumnos
                </a>
            </li>
             <li>
                <a href="{{ url_for('gestion_auxiliares') }}" onclick="event.preventDefault(); loadContent('{{ url_for('gestion_auxiliares') }}'); highlightActiveLink(this);">
                    <i class="fas fa-users-cog nav-icon"></i> Gesti贸n Auxiliares
                </a>
            </li>
             <li>
                <a href="{{ url_for('reportes') }}" onclick="event.preventDefault(); loadContent('{{ url_for('reportes') }}'); highlightActiveLink(this);">
                    <i class="fas fa-chart-line nav-icon"></i> Reportes
                </a>
            </li>
             <li>
                <a href="{{ url_for('soporte') }}" onclick="event.preventDefault(); loadContent('{{ url_for('soporte') }}'); highlightActiveLink(this);">
                     <i class="fas fa-headset nav-icon"></i> Soporte
                </a>
            </li>
        </ul>
        <div class="sidebar-footer">
             <a href="{{ url_for('logout') }}" class="btn btn-logout">
                 <i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n
             </a>
        </div>
    </aside>

    <main class="main-content" id="mainContentArea">
        <div class="welcome-header">
            <h1>Bienvenido Administrador </h1>
            <p>Panel de control del Laboratorio de Electr贸nica / Anal贸gica.</p>
        </div>
    </main>

    <div class="modal fade" id="inactivityModal" tabindex="-1" aria-labelledby="inactivityModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inactivityModalLabel">Advertencia de Inactividad</h5>
                </div>
                <div class="modal-body">
                    <p>Tu sesi贸n est谩 a punto de expirar debido a inactividad.</p>
                    <p>Tiempo restante: <strong id="inactiveTimeLeft">60</strong> segundos.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="forceLogout()">Cerrar Sesi贸n Ahora</button>
                    <button type="button" class="btn btn-primary" onclick="resetInactivityTimer()">Continuar Sesi贸n</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- INICIO SCRIPT INACTIVIDAD ---
        const inactivityLimitSeconds = {{ inactivity_limit | default(300) }};
        const warningTimeSeconds = 60;
        let inactivityTimer, warningTimer, countdownValue, inactivityModal, isWarningModalShown = false;
        function initializeModalInstance(){if(!inactivityModal){const e=document.getElementById("inactivityModal");e?inactivityModal=new bootstrap.Modal(e,{backdrop:"static",keyboard:!1}):console.error("Modal element #inactivityModal not found!")}}function handleUserActivity(){clearTimeout(inactivityTimer),isWarningModalShown&&hideInactivityWarning(),inactivityTimer=setTimeout(showInactivityWarning,(inactivityLimitSeconds-warningTimeSeconds)*1e3)}function showInactivityWarning(){isWarningModalShown=!0,countdownValue=warningTimeSeconds;const e=document.getElementById("inactiveTimeLeft");if(!e)return;e.textContent=countdownValue,initializeModalInstance();if(!inactivityModal)return;try{inactivityModal.show()}catch(e){return void console.error("Error showing modal:",e)}clearInterval(warningTimer),warningTimer=setInterval(()=>{countdownValue--,e&&(e.textContent=countdownValue),countdownValue<=0&&forceLogout()},1e3)}function hideInactivityWarning(){if(isWarningModalShown&&inactivityModal)try{const e=document.getElementById("inactivityModal"),t=bootstrap.Modal.getInstance(e);e&&t&&e.classList.contains("show")&&t.hide()}catch(e){console.error("Error hiding modal:",e)}isWarningModalShown=!1,clearInterval(warningTimer)}async function resetInactivityTimer(){hideInactivityWarning();try{const e=await fetch("{{ url_for('keepalive') }}");if(!e.ok)return console.warn("Server session seems expired. Redirecting to login."),void forceLogout();handleUserActivity()}catch(e){console.error("Error calling keepalive:",e),handleUserActivity()}}function forceLogout(){clearTimeout(inactivityTimer),clearInterval(warningTimer),window.location.href="{{ url_for('logout') }}?reason=inactivity"}document.addEventListener("click",handleUserActivity,!0),document.addEventListener("mousemove",handleUserActivity,!0),document.addEventListener("keypress",handleUserActivity,!0),document.addEventListener("scroll",handleUserActivity,!0),document.addEventListener("DOMContentLoaded",()=>{initializeModalInstance(),handleUserActivity()});
        // --- FIN SCRIPT INACTIVIDAD ---
    </script>
    <script>
        const mainContentArea = document.getElementById('mainContentArea');
        const sidebarLinks = document.querySelectorAll('.sidebar-nav a'); // Selecciona todos los enlaces

        async function loadContent(url) {
            try {
                mainContentArea.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 300px;"><div class="spinner-border text-danger" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                // --- AJUSTA ESTE SELECTOR SI ES NECESARIO ---
                const newContent = doc.querySelector('main') || doc.querySelector('.container-main') || doc.querySelector('.container.main-content') || doc.body; // Busca <main> o clases comunes
                // --- FIN AJUSTE ---
                if (newContent) {
                    mainContentArea.innerHTML = newContent.innerHTML;
                    executeScriptsInElement(mainContentArea);
                } else {
                     mainContentArea.innerHTML = '<div class="alert alert-danger">Error: No se pudo extraer el contenido principal.</div>';
                }
            } catch (error) {
                console.error('Error al cargar el contenido:', error);
                mainContentArea.innerHTML = `<div class="alert alert-danger">Error al cargar la secci贸n: ${error.message}</div>`;
            }
        }

        function highlightActiveLink(clickedLink) {
            sidebarLinks.forEach(link => link.classList.remove('active'));
            if (clickedLink) clickedLink.classList.add('active');
        }

        function executeScriptsInElement(element) {
            const scripts = element.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                if (oldScript.innerHTML) newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const initialUrl = "{{ url_for('profile') }}"; // Carga el perfil al inicio
            const profileLink = document.querySelector('.sidebar-nav a[href="' + initialUrl + '"]');
            if (initialUrl && profileLink) {
                 loadContent(initialUrl);
                 highlightActiveLink(profileLink);
            } else {
                 // Si no se carga nada, muestra el mensaje inicial
                 // (ya est谩 en el HTML por defecto)
            }
        });
    </script>
    </body>
</html>